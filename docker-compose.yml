# HireQ - Docker Compose Configuration
# 
# Usage:
#   Development:  docker-compose up
#   Production:   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Services:
#   - backend:  FastAPI application (port 8000)
#   - frontend: Next.js application (port 3000)
#   - mongodb:  MongoDB database (port 27017)
#   - redis:    Redis cache (port 6379) - optional

version: '3.8'

services:
  # ===========================================================================
  # MongoDB Database
  # ===========================================================================
  mongodb:
    image: mongo:7.0
    container_name: hireq-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
      MONGO_INITDB_DATABASE: hireq
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - hireq-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Redis Cache (Optional - for sessions, caching, real-time features)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: hireq-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - hireq-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # Backend API (FastAPI)
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hireq-backend
    restart: unless-stopped
    environment:
      # Server
      PORT: 8000
      HOST: 0.0.0.0
      DEBUG: ${DEBUG:-false}
      ENVIRONMENT: ${ENVIRONMENT:-development}
      
      # Database
      MONGODB_URI: mongodb://${MONGO_ROOT_USER:-admin}:${MONGO_ROOT_PASSWORD:-changeme}@mongodb:27017/?authSource=admin
      DATABASE_NAME: ${DATABASE_NAME:-hireq}
      
      # JWT
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-this-in-production-minimum-64-characters-long}
      JWT_ALGORITHM: HS256
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: 1440
      
      # Frontend URL for CORS
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      
      # AWS S3 (optional)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET:-hireq-uploads}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      
      # AI
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      
      # Email
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      FROM_EMAIL: ${FROM_EMAIL:-noreply@hireq.app}
    ports:
      - "8000:8000"
    volumes:
      - ./backend/uploads:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - hireq-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================================================
  # Frontend (Next.js) - Development only
  # ===========================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: hireq-frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
    ports:
      - "3000:3000"
    depends_on:
      - backend
    networks:
      - hireq-network

# ===========================================================================
# Networks
# ===========================================================================
networks:
  hireq-network:
    driver: bridge

# ===========================================================================
# Volumes
# ===========================================================================
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  redis_data:
    driver: local
